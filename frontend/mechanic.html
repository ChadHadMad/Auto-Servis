<!DOCTYPE html>
<html lang="hr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Autoservis – Mehaničar</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 40px auto; max-width: 1250px; }
    header { display:flex; justify-content: space-between; align-items:center; margin-bottom: 18px; }
    .pill { font-size: 12px; padding: 6px 10px; border-radius: 999px; background:#f2f2f2; }
    .row { display:flex; gap: 18px; flex-wrap: wrap; }
    .card { border: 1px solid #ddd; border-radius: 8px; padding: 16px; flex: 1; }
    button { padding: 8px 10px; border: 0; border-radius: 6px; cursor: pointer; }
    button.secondary { background: #eee; }
    select { padding: 6px; }
    table { border-collapse: collapse; width: 100%; margin-top: 14px; }
    th, td { border: 1px solid #ccc; padding: 8px; }
    th { background: #eee; }
    .msg { margin-top: 10px; white-space: pre-wrap; }
    .ok { color: #0a7a0a; }
    .err { color: #b00020; }
    .muted { color: #666; font-size: 12px; }
    .status-created { color:#444; }
    .status-in_progress { color:#0b5ed7; font-weight:600; }
    .status-finished { color:#0a7a0a; font-weight:600; }
    .status-cancelled { color:#b00020; font-weight:600; }
  </style>
</head>
<body>

<header>
  <div>
    <h1>Mehaničarski panel</h1>
    <div class="muted">Mehaničar vidi sve narudžbe i mijenja statuse.</div>
  </div>
  <div>
    <span class="pill" id="whoami">...</span>
    <button class="secondary" onclick="logout()">Odjava</button>
  </div>
</header>

<div class="card">
  <h2>Sve narudžbe</h2>

  <button class="secondary" onclick="loadOrders()">Osvježi</button>

  <table>
    <thead>
      <tr>
        <tr>
          <th>ID</th>
          <th>Klijent</th>
          <th>Vozilo</th>
          <th>Datum</th>
          <th>Bilješke</th>
          <th>Status</th>
          <th>Promijeni status</th>
        </tr>

      </tr>
    </thead>
    <tbody id="ordersTbody">
      <tr><td colspan="7" class="muted">Učitavam...</td></tr>
    </tbody>
  </table>

  <div id="ordersMsg" class="msg"></div>
</div>

<script>
  const API = "/api";

  function token() {
    return localStorage.getItem("token");
  }
  function role() {
    return localStorage.getItem("role");
  }
  function logout() {
    localStorage.removeItem("token");
    localStorage.removeItem("role");
    window.location.href = "/index.html";
  }
  function setMsg(el, text, ok=false) {
    el.textContent = text;
    el.className = "msg " + (ok ? "ok" : "err");
  }

  async function loadMe() {
    const pill = document.getElementById("whoami");
    try {
      const res = await fetch(`${API}/auth/me`, {
        headers: { "Authorization": "Bearer " + token() }
      });
      const data = await res.json();
      if (!res.ok) {
        pill.textContent = "Nevažeća prijava";
        return;
      }
      pill.textContent = `${data.email} (${data.role})`;
    } catch {
      pill.textContent = "Greška";
    }
  }

  async function loadOrders() {
    const tbody = document.getElementById("ordersTbody");
    const msgEl = document.getElementById("ordersMsg");
    msgEl.textContent = "";

    try {
      const res = await fetch(`${API}/orders`, {
        headers: { "Authorization": "Bearer " + token() }
      });
      const data = await res.json();

      if (!res.ok) {
        setMsg(msgEl, data?.detail ? JSON.stringify(data.detail, null, 2) : "Ne mogu dohvatiti narudžbe.");
        return;
      }

      if (!data.length) {
        tbody.innerHTML = `<tr><td colspan="7" class="muted">Nema narudžbi.</td></tr>`;
        return;
      }

      tbody.innerHTML = data.map(o => {
        const notesShort = (o.notes || "").trim();
        const display = notesShort.length > 40 ? notesShort.slice(0, 40) + "…" : notesShort;

        return `
          <tr>
            <td style="font-size:12px">${o.id}</td>
            <td>${escapeHtml(o.customer_name)}</td>
            <td>${escapeHtml(o.vehicle)}</td>
            <td>${escapeHtml(o.service_date)}</td>
            <td title="${escapeHtml(notesShort)}">${escapeHtml(display || "-")}</td>
            <td class="status-${o.status}">${escapeHtml(o.status)}</td>
            <td>
              <select onchange="updateStatus('${o.id}', this.value)">
                ${statusOptions(o.status)}
              </select>
            </td>
          </tr>
        `;
      }).join("");


    } catch (e) {
      setMsg(msgEl, "Greška: " + e);
    }
  }

  function statusOptions(current) {
    const all = ["created", "in_progress", "finished"];
    return all.map(s =>
      `<option value="${s}" ${s === current ? "selected" : ""}>${s}</option>`
    ).join("");
  }

  async function updateStatus(orderId, newStatus) {
    const msgEl = document.getElementById("ordersMsg");
    msgEl.textContent = "";

    try {
      const res = await fetch(`${API}/orders/${orderId}/status?status=${newStatus}`, {
        method: "PUT",
        headers: { "Authorization": "Bearer " + token() }
      });
      const data = await res.json();

      if (!res.ok) {
        setMsg(msgEl, data?.detail ? JSON.stringify(data.detail, null, 2) : "Neuspješna promjena statusa.");
        return;
      }

      setMsg(msgEl, `Status promijenjen u "${newStatus}".`, true);
      loadOrders();
    } catch (e) {
      setMsg(msgEl, "Greška: " + e);
    }
  }

  function escapeHtml(s) {
    return String(s)
      .replaceAll("&", "&amp;")
      .replaceAll("<", "&lt;")
      .replaceAll(">", "&gt;")
      .replaceAll('"', "&quot;")
      .replaceAll("'", "&#039;");
  }

  (function init() {
    const t = token();
    const r = role();

    if (!t || !r) {
      window.location.href = "/index.html";
      return;
    }
    if (r !== "mechanic") {
      window.location.href = "/dashboard.html";
      return;
    }

    loadMe();
    loadOrders();
  })();
</script>

</body>
</html>
